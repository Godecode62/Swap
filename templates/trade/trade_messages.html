{% extends 'base.html' %}

{% load static %}

{% block title %}Conversation pour le troc{% endblock %}

{% block content %}
<div class="relative min-h-screen py-16 px-4 bg-gray-950 overflow-hidden font-sans text-gray-200 flex flex-col">
    <div class="absolute inset-0 bg-radial-gradient-t from-gray-800 to-gray-950 opacity-50"></div>
    <div class="absolute inset-0 z-0 opacity-20">
        <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%">
            <defs>
                <pattern id="grid" width="32" height="32" patternUnits="userSpaceOnUse">
                    <path d="M 16 0 L 16 32 M 0 16 L 32 16" fill="none" stroke="rgba(255, 255,255, 0.05)" stroke-width="1"></path>
                </pattern>
            </defs>
            <rect width="100%" height="100%" fill="url(#grid)"></rect>
        </svg>
    </div>

    <div class="w-full max-w-6xl mx-auto p-6 relative z-10 bg-gray-900 rounded-3xl shadow-2xl backdrop-blur-xl border border-gray-700 flex-grow flex flex-col">
        <div class="text-center mb-6 border-b border-gray-700 pb-4">
            
            <div class="flex flex-col items-center justify-center space-y-4">
                {% with other_user=trade_offer.offered_by %}
                {% if request.user == other_user %}
                    {% with other_user=trade_offer.item_requested.owner %}
                    <a href="{% url 'public_profile' other_user.pk %}" class="inline-flex items-center justify-center space-x-3 mb-4 px-6 py-3 rounded-full transition-all duration-300 transform hover:scale-105 border border-purple-500 glassmorphism-card">
                        {% if other_user.profile.profile_picture %}
                            <img src="{{ other_user.profile.profile_picture.url }}" alt="Photo de profil de {{ other_user.username }}" class="w-12 h-12 rounded-full object-cover ring-2 ring-purple-400 shadow-md">
                        {% else %}
                            <img src="{% static 'images/avatar.png' %}" alt="Avatar par défaut" class="w-12 h-12 rounded-full object-cover ring-2 ring-purple-400 shadow-md">
                        {% endif %}
                        <span class="font-bold text-2xl bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-500 pr-2">@{{ other_user.username }}</span>
                    </a>
                    {% endwith %}
                {% else %}
                    <a href="{% url 'public_profile' other_user.pk %}" class="inline-flex items-center justify-center space-x-3 mb-4 px-6 py-3 rounded-full transition-all duration-300 transform hover:scale-105 border border-purple-500 glassmorphism-card">
                        {% if other_user.profile.profile_picture %}
                            <img src="{{ other_user.profile.profile_picture.url }}" alt="Photo de profil de {{ other_user.username }}" class="w-12 h-12 rounded-full object-cover ring-2 ring-purple-400 shadow-md">
                        {% else %}
                            <img src="{% static 'images/avatar.png' %}" alt="Avatar par défaut" class="w-12 h-12 rounded-full object-cover ring-2 ring-purple-400 shadow-md">
                        {% endif %}
                        <span class="font-bold text-2xl bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-500 pr-2">@{{ other_user.username }}</span>
                    </a>
                {% endif %}
                {% endwith %}

                {% if trade_offer.item_requested.owner == request.user and trade_offer.status == 'pending' %}
                    <a href="{% url 'trade_details' trade_offer.pk %}" class="w-full md:w-auto inline-block text-center bg-gradient-to-r from-green-500 to-lime-600 hover:from-green-600 hover:to-lime-700 text-white font-bold py-3 px-6 rounded-full transition duration-300 transform hover:scale-105 shadow-xl">
                        Examiner la demande
                    </a>
                {% endif %}
            </div>
            
            <h1 class="text-3xl font-extrabold text-white bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-blue-500 md:text-4xl mt-6">
                Conversation de troc
            </h1>
            <div class="flex items-center justify-center space-x-4 mt-4">
                <a href="{% url 'item_detail' trade_offer.item_offered.pk %}" class="flex items-center space-x-2 transition-transform duration-300 transform hover:scale-105">
                    <img src="{{ trade_offer.item_offered.photo.url }}" alt="{{ trade_offer.item_offered.title }}" class="w-12 h-12 md:w-16 md:h-16 object-cover rounded-full ring-2 ring-blue-500 shadow-lg">
                    <span class="text-gray-400 hover:text-white font-bold transition-colors duration-200">{{ trade_offer.item_offered.title }}</span>
                </a>
                
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-500 transform rotate-90 md:rotate-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M8 7l4-4 4 4M16 17l-4 4-4-4"></path>
                    <path d="M12 3v18"></path>
                </svg>

                <a href="{% url 'item_detail' trade_offer.item_requested.pk %}" class="flex items-center space-x-2 transition-transform duration-300 transform hover:scale-105">
                    <img src="{{ trade_offer.item_requested.photo.url }}" alt="{{ trade_offer.item_requested.title }}" class="w-12 h-12 md:w-16 md:h-16 object-cover rounded-full ring-2 ring-cyan-500 shadow-lg">
                    <span class="text-gray-400 hover:text-white font-bold transition-colors duration-200">{{ trade_offer.item_requested.title }}</span>
                </a>
            </div>
        </div>

        <div class="flex-grow overflow-y-auto space-y-6 pr-2 custom-scrollbar" id="message-container">
            {% for message in messages %}
                {% if message.sender == request.user %}
                    <div class="flex justify-end animate-fade-in-right">
                        <div class="relative bg-blue-600 text-white rounded-xl py-3 px-5 max-w-xl shadow-xl">
                            <p class="text-sm md:text-base">{{ message.message }}</p>
                            <span class="text-xs text-blue-200 block text-right mt-1 opacity-75">{{ message.created_at|date:"H:i" }}</span>
                            <div class="absolute right-0 bottom-0 -mb-2 w-0 h-0 border-solid border-8 border-transparent border-t-blue-600 border-l-blue-600"></div>
                        </div>
                    </div>
                {% else %}
                    <div class="flex justify-start animate-fade-in-left">
                        <div class="relative bg-gray-700 text-gray-200 rounded-xl py-3 px-5 max-w-xl shadow-xl">
                            <p class="text-sm md:text-base">{{ message.message }}</p>
                            <span class="text-xs text-gray-400 block text-right mt-1 opacity-75">{{ message.created_at|date:"H:i" }}</span>
                            <div class="absolute left-0 bottom-0 -mb-2 w-0 h-0 border-solid border-8 border-transparent border-t-gray-700 border-r-gray-700"></div>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>

        <div class="mt-8">
            <form method="post" action="{% url 'trade_messages' trade_offer.pk %}" class="flex items-center space-x-4">
                {% csrf_token %}
                <div class="flex-grow relative">
                    {{ form.message }}
                </div>
                <button type="submit" class="bg-gradient-to-r from-purple-600 to-fuchsia-500 hover:from-purple-700 hover:to-fuchsia-600 text-white font-bold py-3 px-5 rounded-full transition duration-300 transform hover:scale-105 shadow-xl">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </form>
        </div>
    </div>
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: #1f2937;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #4b5563;
        border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #6b7280;
    }
    textarea#id_message {
        width: 100%;
        padding: 0.75rem 1rem;
        background-color: #1f2937;
        border: 1px solid #4b5563;
        border-radius: 2rem;
        color: #f3f4f6;
        transition: border-color 0.2s, box-shadow 0.2s;
        resize: none;
        min-height: 50px;
    }
    textarea#id_message:focus {
        outline: none;
        border-color: #06b6d4;
        box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.5);
    }
    .glassmorphism-card {
        background: rgba(31, 41, 55, 0.6);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.18);
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const messageContainer = document.getElementById('message-container');
        messageContainer.scrollTop = messageContainer.scrollHeight;
    });
</script>
{% endblock %}